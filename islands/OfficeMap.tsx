import { useEffect, useRef, useState } from "preact/hooks";
import Sidebar from "./Sidebar.tsx";
import MapSelector from "./MapSelector.tsx";
import HomeButton from "./HomeButton.tsx";
import { readFileSync } from "node:fs"; // Denoでファイルを読み込む方法を使う
import path from "node:path";

export default function OfficeMap({ mapData, chairData }) {
    const [isSidebarVisible, setSidebarVisible] = useState(false);
    const [selectedChairId, setSelectedChairId] = useState(null);
    const [selectedMap, setSelectedMap] = useState(null);

    // handleChairClickを親コンポーネントで定義
    const handleChairClick = (id) => {
        setSelectedChairId(id);
        setSidebarVisible(true);
    };

    const handleHomeClick = () => {
        setSelectedChairId(null);
        setSidebarVisible(false);
    };

    const handleMapSelect = (selectedMapData) => {
        setSelectedMap(selectedMapData);
    };

    if (!mapData) {
        return <div>Loading...</div>;
    }

    //メインページ要素の位置はここで調整
    return (
        <div class="office-container flex flex-row justify-center items-start min-h-screen mt-10">
            <div class="sidebar mr-4 mt-16">
                <Sidebar
                    isSidebarVisible={isSidebarVisible}
                    selectedChairId={selectedChairId}
                    chairData={chairData}
                />
            </div>
            <div>
                <MapSelector mapData={mapData} onSelect={handleMapSelect} />
                <div class="mapbody mt-5">
                    <SvgComponent
                        handleChairClick={handleChairClick}
                        selectedMap={selectedMap}
                    />
                </div>
            </div>
        </div>
    );
}

const SvgComponent = ({ handleChairClick, selectedMap }) => {
    const svgRef = useRef(null);
    const [scale, setScale] = useState(1);
    const [offset, setOffset] = useState({ x: 0, y: 0 });

    useEffect(() => {
        const svgElement = svgRef.current;

        if (!svgElement || !selectedMap) return;

        // SVGを設定する
        svgElement.innerHTML = selectedMap.data; // selectedMap.dataがSVGのコンテンツ

        // 特定の条件に合うSVG要素を取得
        const targetElements = svgElement.querySelectorAll('[type="chair"]');

        // Tailwindのホバークラスを追加
        targetElements.forEach((element) => {
            element.classList.add(
                "hover:fill-red-500",
                "transition-colors",
                "duration-300",
                "cursor-pointer",
            );

            // クリック時にhandleChairClickを呼び出す
            element.addEventListener("click", () => {
                const chairId = Number(element.id); // SVG要素のidを取得
                handleChairClick(chairId); // 親コンポーネントのhandleChairClickを呼び出す
            });
        });
    }, [handleChairClick, selectedMap]); // selectedMapが変わったときに再実行

    const handleWheel = (event) => {
        event.preventDefault();
        const zoomFactor = 0.1;
        const delta = event.deltaY;

        let newScale = scale + (delta > 0 ? -zoomFactor : zoomFactor);
        newScale = Math.max(0.5, Math.min(newScale, 3)); // 最小・最大ズーム制限
        setScale(newScale);
    };

    const handleMouseDown = (event) => {
        const startX = event.clientX - offset.x;
        const startY = event.clientY - offset.y;

        const handleMouseMove = (moveEvent) => {
            const dx = moveEvent.clientX - startX;
            const dy = moveEvent.clientY - startY;
            setOffset({ x: dx, y: dy });
        };

        const handleMouseUp = () => {
            window.removeEventListener("mousemove", handleMouseMove);
            window.removeEventListener("mouseup", handleMouseUp);
        };

        window.addEventListener("mousemove", handleMouseMove);
        window.addEventListener("mouseup", handleMouseUp);
    };

    return (
        <div class="window-container relative overflow-hidden w-[1000px] h-[700px] border-4 border-solid border-green-400">
            <div
                ref={svgRef}
                onWheel={handleWheel}
                onMouseDown={handleMouseDown}
                style={{
                    cursor: "grab",
                    transform:
                        `translate(${offset.x}px, ${offset.y}px) scale(${scale})`,
                    transformOrigin: "0 0", // ズームの中心を左上に設定
                    transition: "transform 0.1s ease-out",
                }}
                class="absolute"
            >
                {/* 初期SVG */}
                <svg
                    width="968"
                    height="577"
                    viewBox="0 0 968 577"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <g clip-path="url(#clip0_82_380)">
                        <path
                            d="M753.589 152.225C745.951 147.647 735.221 152.225 728.146 155.835C718.395 160.828 697.534 165.205 683.972 162.61C667.686 159.5 663.621 151.696 644.528 151.074C622.989 150.39 605.5 168.479 605.5 189.931C605.5 202.397 590.564 284.69 527.944 291.979C510.286 294.022 500.805 281.241 486.2 281.241C471.589 281.241 448.623 305.128 440.275 305.128C431.928 305.128 417.316 293.7 401.664 296.826C386.004 299.952 377.649 330.414 354.698 327.303C334.624 324.577 344.252 297.172 365.135 256.64C383.921 224.442 354.698 200.532 345.309 198.466C335.912 196.368 333.829 200.532 341.127 203.649C360.961 220.279 333.829 255.603 321.3 274.313C303.587 300.758 265.13 388.573 395.322 422.031C390.917 440.043 361.223 462.432 363.044 469.66C365.135 477.971 415.874 463.984 435.052 455.804C445.49 451.349 451.916 444.644 455.612 437.393C475.175 440.235 498.72 441.356 519.897 439.497C518.886 457.739 507.153 481.404 510.199 487.318C514.126 494.953 554.412 468.953 571.229 456.626C590.339 442.647 590.215 423.021 585.417 410.334C634.489 362.713 595.715 343.379 638.223 249.374C646.747 230.518 652.171 225.211 664.044 220.033C673.232 216.032 688.785 217.452 703.073 225.748C730.629 241.755 742.873 217.751 733.692 216.232C732.658 216.047 731.192 215.694 729.434 215.187C729.102 212.153 728.577 209.127 727.729 208.866C726.888 208.612 724.528 210.732 722.305 212.968C718.047 211.578 713.141 209.865 708.165 208.083C707.841 205.141 707.317 202.261 706.483 202.015C705.704 201.77 703.59 203.606 701.492 205.686C690.413 201.669 680.292 197.875 677.815 197.184C672.469 195.656 670.942 191.085 677.051 190.325C678.811 190.103 684.897 189.142 692.836 187.775C695.019 190.294 697.565 192.905 698.482 192.606C699.293 192.344 699.964 189.457 700.465 186.461C704.477 185.762 708.743 184.995 713.024 184.203C714.984 187.052 717.437 190.255 718.432 190.048C719.396 189.833 720.592 186.008 721.472 182.606C726 181.73 730.36 180.855 734.317 180.018C736.177 182.675 738.329 185.371 739.247 185.171C740.165 184.979 741.291 181.53 742.155 178.259C746.013 177.336 748.982 176.508 750.526 175.84C761.25 171.266 761.25 156.788 753.589 152.225ZM648.316 187.719C644.929 187.719 642.183 184.992 642.183 181.62C642.183 178.255 644.928 175.522 648.316 175.522C651.687 175.522 654.433 178.255 654.433 181.62C654.433 184.992 651.687 187.719 648.316 187.719Z"
                            fill="#308E4C"
                            fill-opacity="0.5"
                        />
                    </g>
                    <path
                        d="M103.359 575.938C97.1406 575.938 91.5781 574.531 86.6719 571.719C81.7656 568.906 77.8906 564.828 75.0469 559.484C72.2344 554.141 70.8281 547.688 70.8281 540.125C70.8281 532.5 72.25 526.016 75.0938 520.672C77.9688 515.328 81.8594 511.25 86.7656 508.438C91.7031 505.625 97.2344 504.219 103.359 504.219C108.766 504.219 113.625 505.219 117.938 507.219C122.281 509.219 125.828 512.109 128.578 515.891C131.328 519.672 133.016 524.25 133.641 529.625H118.734C118.172 525.781 116.531 522.766 113.812 520.578C111.094 518.359 107.719 517.25 103.688 517.25C98.3125 517.25 93.9844 519.25 90.7031 523.25C87.4219 527.219 85.7812 532.844 85.7812 540.125C85.7812 547.562 87.4219 553.219 90.7031 557.094C94.0156 560.969 98.3281 562.906 103.641 562.906C107.547 562.906 110.859 561.875 113.578 559.812C116.328 557.75 118.047 554.859 118.734 551.141H133.641C133.109 555.422 131.578 559.453 129.047 563.234C126.547 567.016 123.125 570.078 118.781 572.422C114.469 574.766 109.328 575.938 103.359 575.938ZM158.531 544.719V575H144V505.156H158.062V531.922H158.719C159.906 528.828 161.812 526.391 164.438 524.609C167.094 522.828 170.406 521.938 174.375 521.938C179.812 521.938 184.188 523.688 187.5 527.188C190.812 530.688 192.469 535.516 192.469 541.672V575H177.984V544.25C177.984 541 177.172 538.484 175.547 536.703C173.922 534.891 171.594 533.984 168.562 533.984C165.625 533.984 163.219 534.938 161.344 536.844C159.469 538.719 158.531 541.344 158.531 544.719ZM227.719 576.031C222.438 576.031 217.859 574.906 213.984 572.656C210.141 570.375 207.172 567.219 205.078 563.188C203.016 559.125 201.984 554.406 201.984 549.031C201.984 543.625 203.016 538.891 205.078 534.828C207.172 530.766 210.141 527.609 213.984 525.359C217.859 523.078 222.438 521.938 227.719 521.938C233.031 521.938 237.609 523.078 241.453 525.359C245.328 527.609 248.297 530.766 250.359 534.828C252.453 538.891 253.5 543.625 253.5 549.031C253.5 554.406 252.453 559.125 250.359 563.188C248.297 567.219 245.328 570.375 241.453 572.656C237.609 574.906 233.031 576.031 227.719 576.031ZM216.75 548.938C216.75 553.5 217.672 557.266 219.516 560.234C221.359 563.203 224.109 564.688 227.766 564.688C231.391 564.688 234.125 563.203 235.969 560.234C237.812 557.266 238.734 553.5 238.734 548.938C238.734 544.375 237.812 540.625 235.969 537.688C234.125 534.75 231.391 533.281 227.766 533.281C224.109 533.281 221.359 534.75 219.516 537.688C217.672 540.625 216.75 544.375 216.75 548.938ZM286.688 576.031C281.406 576.031 276.828 574.906 272.953 572.656C269.109 570.375 266.141 567.219 264.047 563.188C261.984 559.125 260.953 554.406 260.953 549.031C260.953 543.625 261.984 538.891 264.047 534.828C266.141 530.766 269.109 527.609 272.953 525.359C276.828 523.078 281.406 521.938 286.688 521.938C292 521.938 296.578 523.078 300.422 525.359C304.297 527.609 307.266 530.766 309.328 534.828C311.422 538.891 312.469 543.625 312.469 549.031C312.469 554.406 311.422 559.125 309.328 563.188C307.266 567.219 304.297 570.375 300.422 572.656C296.578 574.906 292 576.031 286.688 576.031ZM275.719 548.938C275.719 553.5 276.641 557.266 278.484 560.234C280.328 563.203 283.078 564.688 286.734 564.688C290.359 564.688 293.094 563.203 294.938 560.234C296.781 557.266 297.703 553.5 297.703 548.938C297.703 544.375 296.781 540.625 294.938 537.688C293.094 534.75 290.359 533.281 286.734 533.281C283.078 533.281 280.328 534.75 278.484 537.688C276.641 540.625 275.719 544.375 275.719 548.938ZM365.531 537.547L352.312 538.344C351.938 536.688 351 535.266 349.5 534.078C348.031 532.859 346.031 532.25 343.5 532.25C341.25 532.25 339.359 532.719 337.828 533.656C336.297 534.594 335.531 535.844 335.531 537.406C335.531 538.656 336.031 539.719 337.031 540.594C338.031 541.469 339.734 542.172 342.141 542.703L351.656 544.578C361.719 546.578 366.75 551.297 366.75 558.734C366.75 562.203 365.75 565.234 363.75 567.828C361.75 570.422 359 572.438 355.5 573.875C352 575.312 347.984 576.031 343.453 576.031C336.516 576.031 331 574.594 326.906 571.719C322.812 568.812 320.406 564.859 319.688 559.859L333.938 559.109C334.906 563.422 338.094 565.578 343.5 565.578C346.031 565.578 348.078 565.078 349.641 564.078C351.203 563.078 351.984 561.812 351.984 560.281C351.984 557.688 349.75 555.938 345.281 555.031L336.234 553.156C326.141 551.125 321.094 546.156 321.094 538.25C321.094 533.188 323.109 529.203 327.141 526.297C331.203 523.391 336.578 521.938 343.266 521.938C349.891 521.938 355.109 523.344 358.922 526.156C362.734 528.938 364.938 532.734 365.531 537.547ZM399.797 576.031C394.422 576.031 389.797 574.938 385.922 572.75C382.047 570.562 379.062 567.453 376.969 563.422C374.875 559.359 373.828 554.562 373.828 549.031C373.828 543.656 374.859 538.938 376.922 534.875C379.016 530.812 381.953 527.641 385.734 525.359C389.516 523.078 393.969 521.938 399.094 521.938C403.719 521.938 407.891 522.922 411.609 524.891C415.359 526.859 418.328 529.812 420.516 533.75C422.734 537.688 423.844 542.625 423.844 548.562V552.5H388.125C388.281 556.469 389.438 559.578 391.594 561.828C393.75 564.078 396.562 565.203 400.031 565.203C402.438 565.203 404.5 564.688 406.219 563.656C407.969 562.625 409.219 561.125 409.969 559.156L423.375 560.047C422.344 564.859 419.766 568.734 415.641 571.672C411.547 574.578 406.266 576.031 399.797 576.031ZM388.219 543.547H409.922C409.578 540.234 408.516 537.609 406.734 535.672C404.953 533.734 402.453 532.766 399.234 532.766C395.984 532.766 393.406 533.781 391.5 535.812C389.625 537.812 388.531 540.391 388.219 543.547ZM483.562 522.594V533.562H473.625V558.875C473.625 562.281 475.281 563.984 478.594 563.984C479.156 563.984 479.766 563.938 480.422 563.844C481.109 563.75 481.703 563.641 482.203 563.516L484.5 574.391C481.406 575.297 478.406 575.75 475.5 575.75C470.312 575.75 466.281 574.438 463.406 571.812C460.562 569.188 459.141 565.516 459.141 560.797V533.562H452.016V522.594H459.141V510.125H473.625V522.594H483.562ZM507.562 544.719V575H493.031V505.156H507.094V531.922H507.75C508.938 528.828 510.844 526.391 513.469 524.609C516.125 522.828 519.438 521.938 523.406 521.938C528.844 521.938 533.219 523.688 536.531 527.188C539.844 530.688 541.5 535.516 541.5 541.672V575H527.016V544.25C527.016 541 526.203 538.484 524.578 536.703C522.953 534.891 520.625 533.984 517.594 533.984C514.656 533.984 512.25 534.938 510.375 536.844C508.5 538.719 507.562 541.344 507.562 544.719ZM576.984 576.031C571.609 576.031 566.984 574.938 563.109 572.75C559.234 570.562 556.25 567.453 554.156 563.422C552.062 559.359 551.016 554.562 551.016 549.031C551.016 543.656 552.047 538.938 554.109 534.875C556.203 530.812 559.141 527.641 562.922 525.359C566.703 523.078 571.156 521.938 576.281 521.938C580.906 521.938 585.078 522.922 588.797 524.891C592.547 526.859 595.516 529.812 597.703 533.75C599.922 537.688 601.031 542.625 601.031 548.562V552.5H565.312C565.469 556.469 566.625 559.578 568.781 561.828C570.938 564.078 573.75 565.203 577.219 565.203C579.625 565.203 581.688 564.688 583.406 563.656C585.156 562.625 586.406 561.125 587.156 559.156L600.562 560.047C599.531 564.859 596.953 568.734 592.828 571.672C588.734 574.578 583.453 576.031 576.984 576.031ZM565.406 543.547H587.109C586.766 540.234 585.703 537.609 583.922 535.672C582.141 533.734 579.641 532.766 576.422 532.766C573.172 532.766 570.594 533.781 568.688 535.812C566.812 537.812 565.719 540.391 565.406 543.547ZM656.531 576.031C651.25 576.031 646.672 574.906 642.797 572.656C638.953 570.375 635.984 567.219 633.891 563.188C631.828 559.125 630.797 554.406 630.797 549.031C630.797 543.625 631.828 538.891 633.891 534.828C635.984 530.766 638.953 527.609 642.797 525.359C646.672 523.078 651.25 521.938 656.531 521.938C661.844 521.938 666.422 523.078 670.266 525.359C674.141 527.609 677.109 530.766 679.172 534.828C681.266 538.891 682.312 543.625 682.312 549.031C682.312 554.406 681.266 559.125 679.172 563.188C677.109 567.219 674.141 570.375 670.266 572.656C666.422 574.906 661.844 576.031 656.531 576.031ZM645.562 548.938C645.562 553.5 646.484 557.266 648.328 560.234C650.172 563.203 652.922 564.688 656.578 564.688C660.203 564.688 662.938 563.203 664.781 560.234C666.625 557.266 667.547 553.5 667.547 548.938C667.547 544.375 666.625 540.625 664.781 537.688C662.938 534.75 660.203 533.281 656.578 533.281C652.922 533.281 650.172 534.75 648.328 537.688C646.484 540.625 645.562 544.375 645.562 548.938ZM695.297 575V533.562H687.938V522.594H695.297V518.797C695.297 513.141 696.922 508.906 700.172 506.094C703.453 503.281 707.547 501.875 712.453 501.875C714.703 501.875 716.75 502.062 718.594 502.438C720.469 502.781 721.844 503.078 722.719 503.328L720.141 514.203C719.578 514.047 718.891 513.891 718.078 513.734C717.266 513.578 716.406 513.5 715.5 513.5C713.375 513.5 711.875 514 711 515C710.156 515.969 709.734 517.344 709.734 519.125V522.594H720.188V533.562H709.734V575H695.297ZM732.516 575V533.562H725.156V522.594H732.516V518.797C732.516 513.141 734.141 508.906 737.391 506.094C740.672 503.281 744.766 501.875 749.672 501.875C751.922 501.875 753.969 502.062 755.812 502.438C757.688 502.781 759.062 503.078 759.938 503.328L757.359 514.203C756.797 514.047 756.109 513.891 755.297 513.734C754.484 513.578 753.625 513.5 752.719 513.5C750.594 513.5 749.094 514 748.219 515C747.375 515.969 746.953 517.344 746.953 519.125V522.594H757.406V533.562H746.953V575H732.516ZM766.312 575V522.594H780.844V575H766.312ZM773.578 515.891C771.422 515.891 769.562 515.172 768 513.734C766.469 512.297 765.703 510.562 765.703 508.531C765.703 506.5 766.469 504.781 768 503.375C769.562 501.938 771.422 501.219 773.578 501.219C775.734 501.219 777.578 501.938 779.109 503.375C780.672 504.781 781.453 506.5 781.453 508.531C781.453 510.562 780.672 512.297 779.109 513.734C777.578 515.172 775.734 515.891 773.578 515.891ZM816.094 576.031C810.719 576.031 806.109 574.891 802.266 572.609C798.422 570.328 795.469 567.156 793.406 563.094C791.375 559.031 790.359 554.344 790.359 549.031C790.359 543.656 791.391 538.938 793.453 534.875C795.547 530.812 798.516 527.641 802.359 525.359C806.203 523.078 810.766 521.938 816.047 521.938C820.609 521.938 824.609 522.766 828.047 524.422C831.484 526.078 834.203 528.406 836.203 531.406C838.203 534.406 839.297 537.938 839.484 542H825.797C825.391 539.406 824.375 537.312 822.75 535.719C821.125 534.094 818.969 533.281 816.281 533.281C812.906 533.281 810.203 534.641 808.172 537.359C806.141 540.047 805.125 543.875 805.125 548.844C805.125 553.844 806.125 557.734 808.125 560.516C810.156 563.297 812.875 564.688 816.281 564.688C818.781 564.688 820.891 563.906 822.609 562.344C824.328 560.781 825.391 558.594 825.797 555.781H839.484C839.266 559.781 838.188 563.312 836.25 566.375C834.312 569.406 831.625 571.781 828.188 573.5C824.781 575.188 820.75 576.031 816.094 576.031ZM872.766 576.031C867.391 576.031 862.766 574.938 858.891 572.75C855.016 570.562 852.031 567.453 849.938 563.422C847.844 559.359 846.797 554.562 846.797 549.031C846.797 543.656 847.828 538.938 849.891 534.875C851.984 530.812 854.922 527.641 858.703 525.359C862.484 523.078 866.938 521.938 872.062 521.938C876.688 521.938 880.859 522.922 884.578 524.891C888.328 526.859 891.297 529.812 893.484 533.75C895.703 537.688 896.812 542.625 896.812 548.562V552.5H861.094C861.25 556.469 862.406 559.578 864.562 561.828C866.719 564.078 869.531 565.203 873 565.203C875.406 565.203 877.469 564.688 879.188 563.656C880.938 562.625 882.188 561.125 882.938 559.156L896.344 560.047C895.312 564.859 892.734 568.734 888.609 571.672C884.516 574.578 879.234 576.031 872.766 576.031ZM861.188 543.547H882.891C882.547 540.234 881.484 537.609 879.703 535.672C877.922 533.734 875.422 532.766 872.203 532.766C868.953 532.766 866.375 533.781 864.469 535.812C862.594 537.812 861.5 540.391 861.188 543.547ZM910.453 552.875L909.375 505.156H924.938L923.906 552.875H910.453ZM908.719 567.828C908.719 565.422 909.5 563.484 911.062 562.016C912.656 560.547 914.688 559.812 917.156 559.812C919.656 559.812 921.688 560.547 923.25 562.016C924.844 563.484 925.641 565.422 925.641 567.828C925.641 570.234 924.844 572.188 923.25 573.688C921.688 575.156 919.656 575.891 917.156 575.891C914.688 575.891 912.656 575.156 911.062 573.688C909.5 572.188 908.719 570.234 908.719 567.828Z"
                        fill="#308E4C"
                        fill-opacity="0.5"
                    />
                    <defs>
                        <clipPath id="clip0_82_380">
                            <rect
                                width="457"
                                height="455"
                                fill="white"
                                transform="translate(302 92)"
                            />
                        </clipPath>
                    </defs>
                </svg>
            </div>
        </div>
    );
};
